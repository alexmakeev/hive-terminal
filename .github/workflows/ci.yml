name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  FLUTTER_VERSION: '3.38.x'

jobs:
  # Static analysis
  analyze:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      - run: flutter pub get
      - run: flutter analyze --fatal-infos

  # Unit and widget tests on Linux
  test-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      - run: flutter pub get
      - run: flutter test --coverage

  # Unit and widget tests on macOS
  test-macos:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      - run: flutter pub get
      - run: flutter test

  # Unit and widget tests on Windows
  test-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      - run: flutter pub get
      - run: flutter test

  # NOTE: Android/iOS/Windows/Linux builds temporarily disabled
  # Only macOS build is active for faster iteration

  # # Build Android APK
  # build-android:
  #   needs: [analyze, test-linux]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-java@v4
  #       with:
  #         distribution: 'temurin'
  #         java-version: '17'
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #     - run: flutter pub get
  #     - name: Build APK (nightly)
  #       run: |
  #         flutter build apk --release \
  #           --dart-define=UPDATE_CHANNEL=nightly \
  #           --dart-define=GIT_COMMIT=${{ github.sha }}
  #     - name: Verify APK exists
  #       run: |
  #         if [ ! -f "build/app/outputs/flutter-apk/app-release.apk" ]; then
  #           echo "APK not found!"
  #           exit 1
  #         fi
  #         echo "APK size: $(ls -lh build/app/outputs/flutter-apk/app-release.apk | awk '{print $5}')"
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: android-apk-${{ github.sha }}
  #         path: build/app/outputs/flutter-apk/app-release.apk
  #         retention-days: 30

  # # Build iOS (no codesign)
  # build-ios:
  #   needs: [analyze, test-macos]
  #   runs-on: macos-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #     - run: flutter pub get
  #     - name: Build iOS (nightly)
  #       run: |
  #         flutter build ios --release --no-codesign \
  #           --dart-define=UPDATE_CHANNEL=nightly \
  #           --dart-define=GIT_COMMIT=${{ github.sha }}
  #     - name: Create IPA
  #       run: |
  #         cd build/ios/iphoneos
  #         mkdir Payload
  #         cp -r Runner.app Payload/
  #         zip -r ../hive-terminal-ios.ipa Payload
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: ios-ipa-${{ github.sha }}
  #         path: build/ios/hive-terminal-ios.ipa
  #         retention-days: 30

  # Build macOS
  build-macos:
    needs: [analyze, test-macos]
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
      - run: flutter pub get
      - name: Build macOS (nightly)
        run: |
          flutter build macos --release \
            --dart-define=UPDATE_CHANNEL=nightly \
            --dart-define=GIT_COMMIT=${{ github.sha }}
      - name: Create DMG
        run: |
          brew install create-dmg || true
          create-dmg \
            --volname "Hive Terminal" \
            --window-pos 200 120 \
            --window-size 600 400 \
            --icon-size 100 \
            --app-drop-link 450 185 \
            build/macos/hive-terminal.dmg \
            build/macos/Build/Products/Release/hive_terminal.app || \
          (cd build/macos/Build/Products/Release && zip -r ../../../hive-terminal-macos.zip hive_terminal.app)
      - uses: actions/upload-artifact@v4
        with:
          name: macos-app-${{ github.sha }}
          path: |
            build/macos/hive-terminal.dmg
            build/macos/hive-terminal-macos.zip
          if-no-files-found: warn
          retention-days: 30

  # # Build Windows
  # build-windows:
  #   needs: [analyze, test-windows]
  #   runs-on: windows-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #     - run: flutter pub get
  #     - name: Build Windows (nightly)
  #       run: |
  #         flutter build windows --release `
  #           --dart-define=UPDATE_CHANNEL=nightly `
  #           --dart-define=GIT_COMMIT=${{ github.sha }}
  #     - name: Bundle VC++ Runtime DLLs
  #       shell: pwsh
  #       run: |
  #         $vcRuntime = "C:\Windows\System32"
  #         $dest = "build\windows\x64\runner\Release"
  #         $dlls = @("msvcp140.dll", "vcruntime140.dll", "vcruntime140_1.dll")
  #         foreach ($dll in $dlls) {
  #           $src = Join-Path $vcRuntime $dll
  #           if (Test-Path $src) {
  #             Copy-Item $src $dest -Force
  #             Write-Host "Copied $dll"
  #           }
  #         }
  #     - name: Create ZIP
  #       run: Compress-Archive -Path build\windows\x64\runner\Release\* -DestinationPath build\windows\hive-terminal-windows.zip
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: windows-zip-${{ github.sha }}
  #         path: build/windows/hive-terminal-windows.zip
  #         retention-days: 30

  # # Build Linux
  # build-linux:
  #   needs: [analyze, test-linux]
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: subosito/flutter-action@v2
  #       with:
  #         flutter-version: ${{ env.FLUTTER_VERSION }}
  #         channel: 'stable'
  #     - name: Install dependencies
  #       run: |
  #         sudo apt-get update
  #         sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev libfuse2
  #     - run: flutter pub get
  #     - name: Build Linux (nightly)
  #       run: |
  #         flutter build linux --release \
  #           --dart-define=UPDATE_CHANNEL=nightly \
  #           --dart-define=GIT_COMMIT=${{ github.sha }}
  #     - name: Create AppImage
  #       run: |
  #         wget -q https://github.com/AppImage/AppImageKit/releases/download/continuous/appimagetool-x86_64.AppImage
  #         chmod +x appimagetool-x86_64.AppImage
  #         mkdir -p AppDir/usr/bin AppDir/usr/lib AppDir/usr/share/applications AppDir/usr/share/icons/hicolor/256x256/apps
  #         cp -r build/linux/x64/release/bundle/* AppDir/usr/bin/
  #         cat > AppDir/usr/share/applications/hive-terminal.desktop << 'DESKTOP'
  #         [Desktop Entry]
  #         Name=Hive Terminal
  #         Comment=Mobile terminal for managing AI agents
  #         Exec=hive_terminal
  #         Icon=hive-terminal
  #         Type=Application
  #         Categories=Development;Utility;TerminalEmulator;
  #         DESKTOP
  #         cp AppDir/usr/share/applications/hive-terminal.desktop AppDir/
  #         cat > AppDir/hive-terminal.svg << 'SVG'
  #         <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
  #           <polygon points="50,5 95,27.5 95,72.5 50,95 5,72.5 5,27.5" fill="#FF9800"/>
  #           <text x="50" y="60" text-anchor="middle" font-size="30" fill="white" font-family="sans-serif">H</text>
  #         </svg>
  #         SVG
  #         cp AppDir/hive-terminal.svg AppDir/usr/share/icons/hicolor/256x256/apps/
  #         cat > AppDir/AppRun << 'APPRUN'
  #         #!/bin/bash
  #         SELF=$(readlink -f "$0")
  #         HERE=${SELF%/*}
  #         export PATH="${HERE}/usr/bin:${PATH}"
  #         export LD_LIBRARY_PATH="${HERE}/usr/bin/lib:${HERE}/usr/lib:${LD_LIBRARY_PATH}"
  #         exec "${HERE}/usr/bin/hive_terminal" "$@"
  #         APPRUN
  #         chmod +x AppDir/AppRun
  #         ARCH=x86_64 ./appimagetool-x86_64.AppImage AppDir hive-terminal-linux.AppImage
  #     - uses: actions/upload-artifact@v4
  #       with:
  #         name: linux-appimage-${{ github.sha }}
  #         path: hive-terminal-linux.AppImage
  #         retention-days: 30
